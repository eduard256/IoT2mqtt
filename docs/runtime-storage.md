# IoT2MQTT Runtime Paths и хранение данных

Документ описывает, как веб-интерфейс и бекенд определяют рабочие пути после обновления 2025‑03, а также какие директории должны присутствовать на хосте.

## Определение корневого каталога

Бекенд больше не зависит от жёсткого расположения `/app`. Класс `ConfigService` использует следующий порядок:

1. Если определена переменная окружения `IOT2MQTT_PATH`, её значение считается корнем.
2. В противном случае выполняется поиск вверх от файла `config_service.py` до ближайшего каталога, содержащего `docker-compose.yml`.
3. Если ничего не найдено, используется текущий рабочий каталог процесса.

Все остальные пути рассчитываются относительно найденного корня, поэтому проект можно запускать из любого расположения — как на хосте, так и внутри контейнера.

## Ключевые каталоги и файлы

- `connectors/` — каталог с интеграциями. Каждая интеграция содержит собственный код, действия и декларативный файл `setup.json`.
- `instances/` — экземпляры интеграций вида `instances/<name>/<instance_id>.json`. Файлы создаются автоматически на целевом сервере и не должны попадать в git.
- `secrets/` — место хранения шифрованных секретов, управляется `SecretsManager` и автоматически создаётся при инициализации.
- `frontend/dist` (или `web/frontend/dist`) — готовая сборка интерфейса. Бекенд ищет `index.html` в нескольких стандартных местах и монтирует найденную директорию как статический SPA.
- `discovered_devices.json` и `discovery_config.json` — теперь лежат в корне проекта и доступны через `ConfigService`. Эти файлы остаются в репозитории, потому что необходимы для предустановленных настроек обнаружения.

## Поведение API

- API интеграций, устройств и автодискавери больше не используют абсолютные пути. Они опираются на значения `ConfigService`, что гарантирует корректную работу после установки через `install.sh` на удалённые серверы.
- Если в каталоге интеграции отсутствует `icon.svg`, веб-интерфейс отдаёт запасной значок из собранного дистрибутива (`dist/icons/default.svg` или `dist/assets/default-icon.svg`).
- Эндпоинт `/api/devices` возвращает единый формат: `{ "success": bool, "message": str, "devices": [...] }`. Фронтенд автоматически нормализует старые и новые ответы.

## Требования при деплое

- При кастомной установке задайте `IOT2MQTT_PATH`, если бекенд запускается вне каталога с `docker-compose.yml`.
- Убедитесь, что `instances/`, `secrets/` и `frontend/dist` доступны на чтение/запись в контейнере `web` (docker-compose уже монтирует эти директории).
- Перед публикацией в git проверьте, что в `instances/` остался только `.gitkeep`, а реальные конфиги и секреты исключены `.gitignore`.

## Отладка

- Для проверки вычисленного корня можно временно вывести `ConfigService().base_path` в логах.
- Если иконки или статические файлы не отдаются, убедитесь, что после сборки фронтенд перемещён в одну из директорий, перечисленных в `_detect_frontend_dist_path()`.
