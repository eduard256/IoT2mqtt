{
  "version": "1.0.0",
  "display_name": "HomeKit",
  "description": "Apple HomeKit integration - control lights, locks, sensors, thermostats and more",
  "author": "IoT2MQTT",
  "requirements": {
    "network": "host"
  },
  "branding": {
    "icon": "icon.svg",
    "color": "#FF9500",
    "category": "smart_home"
  },
  "tools": {
    "discover": {
      "entry": "actions/discover.py",
      "timeout": 15,
      "network": "local",
      "description": "Discover HomeKit devices on local network via mDNS"
    },
    "pair": {
      "entry": "actions/pair.py",
      "timeout": 30,
      "network": "local",
      "description": "Pair with HomeKit device using PIN code"
    },
    "validate": {
      "entry": "actions/validate.py",
      "timeout": 10,
      "network": "local",
      "description": "Validate pairing and retrieve accessories"
    },
    "unpair": {
      "entry": "actions/unpair.py",
      "timeout": 10,
      "network": "local",
      "description": "Unpair from HomeKit device"
    }
  },
  "flows": [
    {
      "id": "auto_discovery",
      "name": "Auto Discovery",
      "description": "Automatically discover HomeKit devices on your network",
      "default": true,
      "steps": [
        {
          "id": "discover_devices",
          "type": "tool",
          "title": "Discovering HomeKit Devices",
          "description": "Scanning your network for HomeKit devices...",
          "tool": "discover",
          "output_key": "discovered_devices",
          "auto_advance": true
        },
        {
          "id": "select_device",
          "type": "select",
          "title": "Select HomeKit Device",
          "description": "Choose a device to add to IoT2MQTT",
          "data_source": "{{ tools.discovered_devices.result.devices }}",
          "item_title": "{{ item.name }}",
          "item_description": "{{ item.model }} - {{ item.ip }} ({{ item.category }})",
          "item_value": "{{ item }}",
          "selection_key": "selected_device"
        },
        {
          "id": "enter_pin",
          "type": "form",
          "title": "Enter PIN Code",
          "description": "Enter the 8-digit PIN code found on your HomeKit device",
          "schema": {
            "fields": [
              {
                "type": "text",
                "name": "pin_code",
                "label": "PIN Code",
                "placeholder": "XXX-XX-XXX",
                "required": true,
                "pattern": "^\\d{3}-\\d{2}-\\d{3}$",
                "description": "Format: XXX-XX-XXX (e.g., 123-45-678)"
              }
            ]
          }
        },
        {
          "id": "pair_device",
          "type": "tool",
          "title": "Pairing Device",
          "description": "Establishing secure connection with HomeKit device...",
          "tool": "pair",
          "input": {
            "ip": "{{ selection.selected_device.ip }}",
            "port": "{{ selection.selected_device.port }}",
            "pin_code": "{{ form.enter_pin.pin_code }}",
            "device_id": "{{ selection.selected_device.device_id }}"
          },
          "output_key": "pairing_result",
          "auto_advance": true
        },
        {
          "id": "validate_pairing",
          "type": "tool",
          "title": "Validating Connection",
          "description": "Retrieving device information...",
          "tool": "validate",
          "input": {
            "pairing_data": "{{ tools.pairing_result.result.pairing_data }}",
            "ip": "{{ selection.selected_device.ip }}",
            "port": "{{ selection.selected_device.port }}"
          },
          "output_key": "validation_result",
          "auto_advance": true
        },
        {
          "id": "summary",
          "type": "summary",
          "title": "Setup Summary",
          "description": "Review the HomeKit device configuration",
          "items": [
            {
              "label": "Device Name",
              "value": "{{ selection.selected_device.name }}"
            },
            {
              "label": "Model",
              "value": "{{ selection.selected_device.model }}"
            },
            {
              "label": "IP Address",
              "value": "{{ selection.selected_device.ip }}"
            },
            {
              "label": "Category",
              "value": "{{ selection.selected_device.category }}"
            },
            {
              "label": "Accessories Found",
              "value": "{{ tools.validation_result.result.accessories_count }}"
            }
          ]
        },
        {
          "id": "create_instance",
          "type": "instance",
          "instance": {
            "connector_type": "homekit",
            "friendly_name": "{{ selection.selected_device.name }}",
            "config": {
              "hap_service_port": 8765
            },
            "devices": [
              {
                "device_id": "{{ selection.selected_device.device_id }}",
                "pairing_id": "{{ tools.pairing_result.result.pairing_id }}",
                "aid": 1,
                "name": "{{ selection.selected_device.name }}",
                "model": "{{ selection.selected_device.model }}",
                "category": "{{ selection.selected_device.category }}",
                "connection": "{{ selection.selected_device.transport }}",
                "ip": "{{ selection.selected_device.ip }}",
                "port": "{{ selection.selected_device.port }}",
                "accessories": "{{ tools.validation_result.result.accessories }}",
                "enabled": true
              }
            ],
            "secrets": ["pairing_data"]
          }
        }
      ]
    },
    {
      "id": "manual_entry",
      "name": "Manual Entry",
      "description": "Manually enter HomeKit device IP address and PIN code",
      "steps": [
        {
          "id": "device_details",
          "type": "form",
          "title": "Device Connection Details",
          "description": "Enter the IP address and PIN code of your HomeKit device",
          "schema": {
            "fields": [
              {
                "type": "text",
                "name": "friendly_name",
                "label": "Device Name",
                "placeholder": "Living Room Light",
                "required": true
              },
              {
                "type": "text",
                "name": "ip",
                "label": "IP Address",
                "placeholder": "192.168.1.100",
                "required": true,
                "pattern": "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
              },
              {
                "type": "number",
                "name": "port",
                "label": "Port",
                "default": 55443,
                "advanced": true
              },
              {
                "type": "text",
                "name": "pin_code",
                "label": "PIN Code",
                "placeholder": "XXX-XX-XXX",
                "required": true,
                "pattern": "^\\d{3}-\\d{2}-\\d{3}$",
                "description": "8-digit PIN code (format: XXX-XX-XXX)"
              }
            ]
          }
        },
        {
          "id": "pair_manual",
          "type": "tool",
          "title": "Pairing Device",
          "description": "Establishing secure connection...",
          "tool": "pair",
          "input": {
            "ip": "{{ form.device_details.ip }}",
            "port": "{{ form.device_details.port }}",
            "pin_code": "{{ form.device_details.pin_code }}"
          },
          "output_key": "pairing_result",
          "auto_advance": true
        },
        {
          "id": "validate_manual",
          "type": "tool",
          "title": "Validating Connection",
          "description": "Retrieving device information...",
          "tool": "validate",
          "input": {
            "pairing_data": "{{ tools.pairing_result.result.pairing_data }}",
            "ip": "{{ form.device_details.ip }}",
            "port": "{{ form.device_details.port }}"
          },
          "output_key": "validation_result",
          "auto_advance": true
        },
        {
          "id": "summary_manual",
          "type": "summary",
          "title": "Setup Summary",
          "description": "Review the configuration",
          "items": [
            {
              "label": "Device Name",
              "value": "{{ form.device_details.friendly_name }}"
            },
            {
              "label": "IP Address",
              "value": "{{ form.device_details.ip }}"
            },
            {
              "label": "Model",
              "value": "{{ tools.validation_result.result.model }}"
            },
            {
              "label": "Accessories Found",
              "value": "{{ tools.validation_result.result.accessories_count }}"
            }
          ]
        },
        {
          "id": "create_instance_manual",
          "type": "instance",
          "instance": {
            "connector_type": "homekit",
            "friendly_name": "{{ form.device_details.friendly_name }}",
            "config": {
              "hap_service_port": 8765
            },
            "devices": [
              {
                "device_id": "{{ tools.pairing_result.result.device_id }}",
                "pairing_id": "{{ tools.pairing_result.result.pairing_id }}",
                "aid": 1,
                "name": "{{ form.device_details.friendly_name }}",
                "model": "{{ tools.validation_result.result.model }}",
                "category": "{{ tools.validation_result.result.category }}",
                "connection": "IP",
                "ip": "{{ form.device_details.ip }}",
                "port": "{{ form.device_details.port }}",
                "accessories": "{{ tools.validation_result.result.accessories }}",
                "enabled": true
              }
            ],
            "secrets": ["pairing_data"]
          }
        }
      ]
    }
  ]
}
