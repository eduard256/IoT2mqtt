{
    "version": "1.0.0",
    "display_name": "Yeelight",
    "description": "Control Yeelight smart lighting with local network access.",
    "author": "IoT2MQTT",
    "branding": {
        "icon": "/assets/brands/yeelight.svg",
        "color": "#FF7E35",
        "category": "lighting"
    },
    "requirements": {
        "network": "host",
        "python": "3.11",
        "libraries": [
            "yeelight"
        ]
    },
    "tools": {
        "discover_devices": {
            "entry": "actions/discover.py",
            "timeout": 15,
            "network": "local"
        },
        "validate_device": {
            "entry": "actions/validate.py",
            "timeout": 10,
            "network": "local"
        }
    },
    "flows": [
        {
            "id": "auto_discovery",
            "name": "Auto Discovery",
            "description": "Scan the network and configure discovered devices automatically.",
            "default": true,
            "steps": [
                {
                    "id": "scan",
                    "type": "tool",
                    "title": "Discover Yeelight devices",
                    "description": "IoT2MQTT will scan your local network for compatible lights.",
                    "tool": "discover_devices",
                    "auto_advance": true
                },
                {
                    "id": "select_device",
                    "type": "select",
                    "title": "Select a device",
                    "description": "Choose which device you want to onboard.",
                    "items": "{{ tools.discover_devices.result.devices }}",
                    "item_label": "{{ item.friendly_name }} ({{ item.ip }})",
                    "item_value": {
                        "device_id": "{{ item.device_id }}",
                        "ip": "{{ item.ip }}",
                        "port": "{{ item.port }}",
                        "model": "{{ item.model }}",
                        "friendly_name": "{{ item.friendly_name }}"
                    },
                    "output_key": "selected_device"
                },
                {
                    "id": "instance_details",
                    "type": "form",
                    "title": "Instance details",
                    "description": "Name the instance and optionally adjust default behaviour.",
                    "schema": {
                        "fields": [
                            {
                                "type": "text",
                                "name": "instance_id",
                                "label": "Instance ID",
                                "required": true,
                                "placeholder": "yeelight_living",
                                "default": "{{ selection.selected_device.device_id }}"
                            },
                            {
                                "type": "text",
                                "name": "friendly_name",
                                "label": "Friendly name",
                                "required": true,
                                "default": "{{ selection.selected_device.friendly_name }}"
                            },
                            {
                                "type": "select",
                                "name": "effect_type",
                                "label": "Default transition",
                                "default": "smooth",
                                "options": [
                                    {
                                        "value": "smooth",
                                        "label": "Smooth"
                                    },
                                    {
                                        "value": "sudden",
                                        "label": "Sudden"
                                    }
                                ]
                            },
                            {
                                "type": "number",
                                "name": "duration",
                                "label": "Transition duration (ms)",
                                "default": 300,
                                "min": 30,
                                "max": 10000,
                                "step": 50
                            }
                        ]
                    },
                    "actions": [
                        {
                            "type": "goto_flow",
                            "label": "Switch to manual setup",
                            "flow": "manual_entry"
                        }
                    ]
                },
                {
                    "id": "summary",
                    "type": "summary",
                    "title": "Review",
                    "sections": [
                        {
                            "label": "Device",
                            "value": "{{ selection.selected_device.friendly_name }}"
                        },
                        {
                            "label": "IP Address",
                            "value": "{{ selection.selected_device.ip }}"
                        },
                        {
                            "label": "Instance",
                            "value": "{{ form.instance_details.instance_id }}"
                        }
                    ]
                },
                {
                    "id": "create",
                    "type": "instance",
                    "instance": {
                        "instance_id": "{{ form.instance_details.instance_id }}",
                        "friendly_name": "{{ form.instance_details.friendly_name }}",
                        "connector_type": "yeelight",
                        "update_interval": 10,
                        "config": {
                            "discovery_enabled": true,
                            "discovery_interval": 300,
                            "effect_type": "{{ form.instance_details.effect_type }}",
                            "duration": "{{ form.instance_details.duration }}"
                        },
                        "devices": [
                            {
                                "device_id": "{{ selection.selected_device.device_id }}",
                                "ip": "{{ selection.selected_device.ip }}",
                                "port": "{{ selection.selected_device.port }}",
                                "name": "{{ selection.selected_device.friendly_name }}",
                                "model": "{{ selection.selected_device.model }}",
                                "enabled": true
                            }
                        ]
                    }
                }
            ]
        },
        {
            "id": "manual_entry",
            "name": "Manual",
            "description": "Manually specify device parameters.",
            "steps": [
                {
                    "id": "device_form",
                    "type": "form",
                    "title": "Device details",
                    "schema": {
                        "fields": [
                            {
                                "type": "text",
                                "name": "instance_id",
                                "label": "Instance ID",
                                "required": true
                            },
                            {
                                "type": "text",
                                "name": "friendly_name",
                                "label": "Friendly name",
                                "required": true
                            },
                            {
                                "type": "text",
                                "name": "ip",
                                "label": "IP address",
                                "required": true
                            },
                            {
                                "type": "number",
                                "name": "port",
                                "label": "Port",
                                "default": 55443
                            },
                            {
                                "type": "select",
                                "name": "effect_type",
                                "label": "Transition",
                                "default": "smooth",
                                "options": [
                                    {
                                        "value": "smooth",
                                        "label": "Smooth"
                                    },
                                    {
                                        "value": "sudden",
                                        "label": "Sudden"
                                    }
                                ]
                            },
                            {
                                "type": "number",
                                "name": "duration",
                                "label": "Transition duration (ms)",
                                "default": 300,
                                "min": 30,
                                "max": 10000,
                                "step": 50
                            }
                        ]
                    },
                    "actions": [
                        {
                            "type": "goto_flow",
                            "label": "Use discovery instead",
                            "flow": "auto_discovery"
                        }
                    ]
                },
                {
                    "id": "validate",
                    "type": "tool",
                    "title": "Validate device",
                    "description": "Verify the device responds before finishing.",
                    "tool": "validate_device",
                    "input": {
                        "host": "{{ form.device_form.ip }}",
                        "port": "{{ form.device_form.port }}"
                    },
                    "optional": true
                },
                {
                    "id": "manual_summary",
                    "type": "summary",
                    "title": "Review",
                    "sections": [
                        {
                            "label": "Instance",
                            "value": "{{ form.device_form.instance_id }}"
                        },
                        {
                            "label": "Device",
                            "value": "{{ form.device_form.friendly_name }}"
                        },
                        {
                            "label": "IP",
                            "value": "{{ form.device_form.ip }}:{{ form.device_form.port }}"
                        }
                    ]
                },
                {
                    "id": "manual_create",
                    "type": "instance",
                    "instance": {
                        "instance_id": "{{ form.device_form.instance_id }}",
                        "friendly_name": "{{ form.device_form.friendly_name }}",
                        "connector_type": "yeelight",
                        "update_interval": 10,
                        "config": {
                            "discovery_enabled": false,
                            "effect_type": "{{ form.device_form.effect_type }}",
                            "duration": "{{ form.device_form.duration }}"
                        },
                        "devices": [
                            {
                                "device_id": "{{ form.device_form.instance_id }}",
                                "ip": "{{ form.device_form.ip }}",
                                "port": "{{ form.device_form.port }}",
                                "name": "{{ form.device_form.friendly_name }}",
                                "enabled": true
                            }
                        ]
                    }
                }
            ]
        }
    ]
}
